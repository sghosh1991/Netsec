input {

#For syslogs generated by USA
  file {
    type => "syslog"
    path => [ "/var/log/auth.log","/var/log/mail.log","/var/log/syslog" ]
  }

#For syslogs generated by others Redis server is used

	redis {
		#Take input from redis server in USA IP 52.10.131.219

		host => "52.10.131.219"
		type => "redis-input"
		data_type => "list"
		key => "logstash"
	}

}


 
filter{


#++++++++++++++++++++++++++++
#Condition for SSH:
#++++++++++++++++++++++++++++


if[message] =~ /.*CSE523.*/ {


  grok {
    match => ["message","%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host_target} sshd\[%{BASE10NUM}\]: CSE523 %{WORD:status} Authentication attempt using password: %{DATA:password} for (invalid user |)%{USERNAME:username} from %{IP:src_ip} port %{BASE10NUM:port}"]

    add_field => {

			"Service_Type" => "SSH"
		}
    
  }#end of grok for SSH
}#end of if



#++++++++++++++++++++++++++++
#Condition for POP3:
#++++++++++++++++++++++++++++



else if[message] =~ /.*dovecot.*/ and [message] =~ /.*pam_authenticate\(\)/{

	grok{

		match => ["message","%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host_target} dovecot: auth-worker\(%{BASE10NUM}\): pam\(%{DATA:username},%{IP:src_ip}\): pam_authenticate\(\) failed: Authentication failure \(password mismatch\?\) \(given password: %{DATA:password}\)"]



	add_field => {

			"Service_Type" => "POP3"
			"status" => "Failed"
		}

	} #end of grok for FTP

}#end of if for ftp




#++++++++++++++++++++++++++++
#Condition for JOOMLA
#++++++++++++++++++++++++++++


else if[message] =~/.*CSE508_joomla.*/ {


	grok{
	
		match => ["message" , "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host_target} apache2: CSE508_joomla %{WORD:status} login from IP:%{IP:src_ip} user:%{DATA:username} password:%{GREEDYDATA:password}"]

	add_field => {

		"Service_Type" => "Joomla"
		#"status" => "Failed"	
		
		}
	}#end of grok for joomla

	if[status] == "unsuccessful" {

		mutate{
		 add_field => {"status" => "Failed"}

		}
	}
	else{

		mutate {


			add_field => {"status" => "Succesful"}

			}	

	}
}#end of if for joomla



#++++++++++++++++++++++++++++
#Condition for FTP:
#++++++++++++++++++++++++++++


else if[message] =~/.*CSE508_FTP.*/ {


	grok{
	
		match => ["message" , "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host_target} pure-ftpd: \(\?\@%{IP:src_ip}\) \[INFO\] CSE508_FTP Accessed by UserName: %{USERNAME:username} and Password:%{DATA:password} and Auth: %{WORD:status}"]

	add_field => {

		"Service_Type" => "FTP"
			
		
		}

	}#end of grok for FTP


	if[status] == "Failed" {

		mutate{
                 add_field => {"status" => "Failed"}

                }
	}
        else{

                mutate {


                        add_field => {"status" => "Succesful"}

                        }

        }




}#end of if for FTP


#++++++++++++++++++++++++++++
#Condition for WORDPRESS:
#++++++++++++++++++++++++++++


else if[message] =~/.*CSE508_wordpress.*/ {


	grok{
	
		match => ["message" , "%{SYSLOGTIMESTAMP:timestamp} %{HOSTNAME:host_target} apache2: CSE508_wordpress Accessed with UserName: %{USERNAME:username} and Password: %{DATA:password} from IP:%{IP:src_ip}"]

	add_field => {

		"Service_Type" => "Wordpress"
		"status" => "Failed"	
		
		}


	}#end of grok for Wordpress


}#end of if for Wordpress




#++++++++++++++++++++++++++++
#Drop other values
#++++++++++++++++++++++++++++
  
else {

	drop{}

}#if all else fails drop the message

}

#++++++++++++++++++++++++++++++++++++++++++++++
#Tag it with the site name based on host_name
#+++++++++++++++++++++++++++++++++++++++++++++

filter{

if[host_target] == "ip-172-31-2-172" {

	mutate{
		add_field => {"Site" => "Japan"}
	}
}

else if[host_target] == "ip-172-31-37-7"{

	mutate{

		add_field =>  { "Site" => "USA" }
	}

}

else if[host_target] == "ip-172-31-18-190" {

	mutate {
		add_field => { "Site" => "Ireland" }
	}

}

}


filter {
	geoip{
		source => "src_ip"
		database => "/home/ubuntu/Netsec/logstash-1.4.2/GeoIP.dat"
	}
}


output {
  stdout { codec => rubydebug }
  elasticsearch { host => localhost }
}

